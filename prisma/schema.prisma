// ============================================================
// PRISMA SCHEMA - Personal Finance Management API
// ============================================================
// Each "model" here → becomes one table in PostgreSQL.
// After editing this file, run:
//   npx prisma migrate dev --name <description>
// ============================================================

generator client {
  provider = "prisma-client"
  output   = "../generated/prisma"
}

datasource db {
  provider = "postgresql"
  // url is configured in prisma.config.ts (Prisma v7 pattern)
}

// ============================================================
// MODEL: User
// ============================================================
model User {
  id        String   @id @default(uuid())
  email     String   @unique
  password  String
  firstName String   @map("first_name")
  lastName  String   @map("last_name")
  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  accounts     Account[]
  categories   Category[]
  transactions Transaction[]
  budgets      Budget[]

  @@map("users")
}

// ============================================================
// MODEL: Account
// ============================================================
model Account {
  id          String      @id @default(uuid())
  name        String
  type        AccountType
  balance     Decimal     @default(0) @db.Decimal(15, 2)
  currency    String      @default("USD")
  description String?
  isActive    Boolean     @default(true) @map("is_active")
  createdAt   DateTime    @default(now()) @map("created_at")
  updatedAt   DateTime    @updatedAt @map("updated_at")

  userId String  @map("user_id")
  user   User    @relation(fields: [userId], references: [id], onDelete: Cascade)

  // Transactions where this account is the SOURCE (income/expense/transfer-from)
  transactions   Transaction[] @relation("TransactionFromAccount")
  // Transactions where this account is the DESTINATION (transfer-to only)
  toTransactions Transaction[] @relation("TransactionToAccount")

  @@map("accounts")
}

// ============================================================
// MODEL: Category
// ============================================================
model Category {
  id          String       @id @default(uuid())
  name        String
  type        CategoryType
  color       String?
  icon        String?
  description String?
  createdAt   DateTime     @default(now()) @map("created_at")
  updatedAt   DateTime     @updatedAt @map("updated_at")

  userId String   @map("user_id")
  user   User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  transactions Transaction[]
  budgets      Budget[]

  @@map("categories")
}

// ============================================================
// MODEL: Transaction
// ============================================================
model Transaction {
  id          String          @id @default(uuid())
  amount      Decimal         @db.Decimal(15, 2)
  type        TransactionType
  description String?
  date        DateTime
  createdAt   DateTime        @default(now()) @map("created_at")
  updatedAt   DateTime        @updatedAt @map("updated_at")

  userId String @map("user_id")
  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)

  // Source account — always required
  accountId String  @map("account_id")
  account   Account @relation("TransactionFromAccount", fields: [accountId], references: [id], onDelete: Cascade)

  // Destination account — only set when type = TRANSFER
  toAccountId String?  @map("to_account_id")
  toAccount   Account? @relation("TransactionToAccount", fields: [toAccountId], references: [id], onDelete: SetNull)

  categoryId String?   @map("category_id")
  category   Category? @relation(fields: [categoryId], references: [id], onDelete: SetNull)

  @@map("transactions")
}

// ============================================================
// MODEL: Budget
// ============================================================
model Budget {
  id        String   @id @default(uuid())
  amount    Decimal  @db.Decimal(15, 2)
  month     Int
  year      Int
  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  userId String @map("user_id")
  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)

  categoryId String   @map("category_id")
  category   Category @relation(fields: [categoryId], references: [id], onDelete: Cascade)

  @@unique([userId, categoryId, month, year])
  @@map("budgets")
}

// ============================================================
// ENUMS — Fixed sets of allowed values
// ============================================================

enum AccountType {
  CHECKING
  SAVINGS
  CREDIT_CARD
  INVESTMENT
  CASH
  OTHER
}

enum CategoryType {
  INCOME
  EXPENSE
}

enum TransactionType {
  INCOME
  EXPENSE
  TRANSFER
}
